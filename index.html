<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Reserva de Aniversário • Mercatto Delícia</title>
  <style>
    :root{
      --brand:#d4af37; --brand-2:#f5d26a; --bg:#0a0a0a; --card:#111214;
      --text:#f8f7f4; --muted:#cfc8b0; --line:#262626;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:920px;margin:0 auto;padding:24px}
    h1{margin:0 0 12px;font-size:22px;color:var(--brand-2)}
    .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:18px}
    label{display:block;margin:6px 0 6px;color:var(--muted);font-size:14px}
    input,textarea,button{
      width:100%;padding:12px;border-radius:10px;border:1px solid var(--line);
      background:#0c0d0f;color:var(--text);font-size:15px;outline:none
    }
    textarea{min-height:100px;resize:vertical}
    .grid{display:grid;gap:12px}
    @media(min-width:840px){ .grid.cols-2{grid-template-columns:1fr 1fr} }
    .btn{cursor:pointer;border:0;background:linear-gradient(180deg,var(--brand),#c79b1d);color:#1a1500;font-weight:800}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .ok{color:#22c55e}
    .err{color:#f87171}
    .top{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .brand{font-weight:800;color:var(--brand-2)}
    .whats{display:inline-flex;gap:8px;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 12px;color:var(--text);text-decoration:none}
    /* Modal para mobile (também funciona no desktop) */
    .actions{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;display:flex;gap:12px;z-index:20}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;padding:12px;z-index:30}
    .modal.show{display:flex}
    .sheet{background:var(--card);border:1px solid var(--line);border-radius:16px;max-width:520px;width:100%;padding:18px}
    .close{background:#0000;border:1px solid var(--line);border-radius:8px;color:var(--text);padding:8px 10px;cursor:pointer}
    /* Desktop: formulário fixo na página; Mobile: usa modal */
    @media(min-width:840px){
      .mobile-only{display:none}
    }
    @media(max-width:839px){
      .desktop-only{display:none}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">Mercatto Delícia — Reserva de Aniversário</div>
      <a class="whats" id="linkAtendente" target="_blank" rel="noopener">Falar com atendente</a>
    </div>

    <!-- FORM DESKTOP (fixo) -->
    <section class="card desktop-only">
      <h1>Faça sua reserva</h1>
      <p class="muted">Preencha os dados abaixo. Entraremos em contato para confirmar.</p>
      <form id="formDesk" class="grid cols-2" novalidate>
        <div><label for="d_nome">Nome completo *</label><input id="d_nome" required autocomplete="name"></div>
        <div><label for="d_email">Email</label><input id="d_email" type="email" autocomplete="email"></div>
        <div><label for="d_telefone">Telefone (com DDD) *</label><input id="d_telefone" required inputmode="tel" placeholder="(99) 99999-9999"></div>
        <div><label for="d_pessoas">Qtd. pessoas *</label><input id="d_pessoas" type="number" min="1" max="1000" required></div>
        <div><label for="d_data">Data *</label><input id="d_data" type="date" required></div>
        <div><label for="d_hora">Hora *</label><input id="d_hora" type="time" required></div>
        <div class="grid" style="grid-template-columns:1fr"><label for="d_mesa">Nº da mesa (opcional)</label><input id="d_mesa"></div>
        <div class="grid" style="grid-template-columns:1fr"><label for="d_obs">Observações</label><textarea id="d_obs" placeholder="Preferências, levar bolo, etc."></textarea></div>
        <div class="row" style="grid-column:1/-1;justify-content:flex-end">
          <span id="d_msg" class="muted"></span>
          <button id="btnDesk" class="btn" type="submit" style="min-width:160px">Enviar reserva</button>
        </div>
      </form>
    </section>

    <!-- BOTÕES MOBILE -->
    <div class="actions mobile-only">
      <button class="btn" id="abrirMobile" type="button">Reservar</button>
    </div>
  </div>

  <!-- MODAL MOBILE -->
  <div class="modal" id="modalMobile" aria-hidden="true">
    <div class="sheet">
      <div class="row" style="justify-content:space-between;margin-bottom:8px">
        <h1 style="margin:0">Faça sua reserva</h1>
        <button class="close" id="fecharMobile">Fechar</button>
      </div>
      <form id="formMobile" class="grid" novalidate>
        <input id="hp" style="position:absolute;left:-9999px" tabindex="-1" autocomplete="off">
        <div><label for="m_nome">Nome completo *</label><input id="m_nome" required autocomplete="name"></div>
        <div><label for="m_email">Email</label><input id="m_email" type="email" autocomplete="email"></div>
        <div><label for="m_telefone">Telefone (com DDD) *</label><input id="m_telefone" required inputmode="tel" placeholder="(99) 99999-9999"></div>
        <div class="grid cols-2">
          <div><label for="m_pessoas">Qtd. pessoas *</label><input id="m_pessoas" type="number" min="1" max="1000" required></div>
          <div><label for="m_mesa">Mesa (opcional)</label><input id="m_mesa"></div>
        </div>
        <div class="grid cols-2">
          <div><label for="m_data">Data *</label><input id="m_data" type="date" required></div>
          <div><label for="m_hora">Hora *</label><input id="m_hora" type="time" required></div>
        </div>
        <div><label for="m_obs">Observações</label><textarea id="m_obs"></textarea></div>
        <div class="row" style="justify-content:flex-end">
          <span id="m_msg" class="muted"></span>
          <button id="btnMobile" class="btn" type="submit" style="min-width:160px">Enviar</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Confete -->
  <canvas id="boom" style="position:fixed;inset:0;pointer-events:none"></canvas>

<script>
  // ======= CONFIG =========
  const CONFIG = {
    SHEET_ENDPOINT: "https://script.google.com/macros/s/AKfycbzayt_VYGArc27xm29KwwmcLysleze_bISUQOEMRmNLY2Koo-u1ge4sv-_cuQWi8y7u/exec", // <= Cole aqui a URL do seu Apps Script (Web App)
    ATENDENTE_WHATS: "557736135148",
    ATENDENTE_MSG: "Olá! Gostaria de falar com um atendente sobre reserva de aniversário."
  };

  // ======= HELPERS =======
  const $ = sel => document.querySelector(sel);
  const setBtn = (btn, on, txt='Enviando...')=>{
    if(!btn) return;
    if(on){ btn.dataset.old=btn.textContent; btn.textContent=txt; btn.disabled=true; }
    else { btn.textContent=btn.dataset.old||'Enviar'; btn.disabled=false; }
  };
  const maskPhone = v => {
    const d = String(v).replace(/\D/g,'').slice(0,11);
    return d.length<=10 ? d.replace(/^(\d{2})(\d{4})(\d{0,4}).*/,"($1) $2-$3")
                        : d.replace(/^(\d{2})(\d{5})(\d{0,4}).*/,"($1) $2-$3");
  };
  function confetti3s(){
    const c=$('#boom'),x=c.getContext('2d');
    const fit=()=>{c.width=innerWidth;c.height=innerHeight}; fit(); addEventListener('resize',fit);
    const dots=Array.from({length:120},()=>({x:Math.random()*c.width,y:0,r:Math.random()*5+3,s:Math.random()*3+2,h:Math.random()*360}));
    const id=setInterval(()=>{ x.clearRect(0,0,c.width,c.height);
      dots.forEach(d=>{ x.beginPath(); x.arc(d.x,d.y,d.r,0,2*Math.PI); x.fillStyle=`hsl(${d.h} 100% 50%)`; x.fill();
        d.y+=d.s; if(d.y>c.height){ d.y=0; d.x=Math.random()*c.width; d.h=Math.random()*360; }});
    },20);
    setTimeout(()=>{clearInterval(id);x.clearRect(0,0,c.width,c.height)},3000);
  }

  // WhatsApp link
  $('#linkAtendente').href = `https://wa.me/${CONFIG.ATENDENTE_WHATS}?text=${encodeURIComponent(CONFIG.ATENDENTE_MSG)}`;

  // ======= ENVIO (cliente) — só campos do formulário =======
  async function enviarReserva({nome,email,telefone,pessoas,mesa,data,hora,observacoes,btn,msgEl}){
    if(!nome || !telefone || !pessoas || !data || !hora){
      msgEl && (msgEl.textContent='Preencha os obrigatórios.'); return false;
    }
    // valida telefone simples
    const telDigits = telefone.replace(/\D/g,''); if(telDigits.length<10){ msgEl&&(msgEl.textContent='Telefone incompleto.'); return false; }
    // proíbe passado
    const dh = new Date(`${data}T${hora}:00`);
    if(isFinite(dh) && dh < new Date()){ msgEl&&(msgEl.textContent='Data/hora no passado.'); return false; }

    const payload = {
      // Apenas os campos da planilha:
      Nome:nome.trim(),
      Email:(email||'').trim(),
      Telefone:telefone.trim(),
      Pessoas:String(pessoas).trim(),
      Mesa:(mesa||'').trim(),
      DataHora:`${data} ${hora}`,
      Observacoes:(observacoes||'').trim()
      // ID, Carimbo e Status são gerados no servidor
    };

    try{
      setBtn(btn, true);
      const r = await fetch(CONFIG.SHEET_ENDPOINT, {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const j = await r.json().catch(()=>({}));
      if(!r.ok || !j.ok){ throw new Error((j && j.error) || 'Falha ao salvar'); }
      msgEl && (msgEl.innerHTML = `<span class="ok">Reserva enviada! ID: ${j.id||'—'}</span>`);
      confetti3s();
      return true;
    }catch(e){
      console.error(e);
      msgEl && (msgEl.innerHTML = `<span class="err">Erro ao enviar. Tente novamente.</span>`);
      return false;
    }finally{
      setBtn(btn, false);
    }
  }

  // ======= DESKTOP form =======
  $('#d_telefone').addEventListener('input', e=> e.target.value = maskPhone(e.target.value));
  $('#formDesk').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    const ok = await enviarReserva({
      nome: $('#d_nome').value, email: $('#d_email').value, telefone: $('#d_telefone').value,
      pessoas: $('#d_pessoas').value, mesa: $('#d_mesa').value, data: $('#d_data').value,
      hora: $('#d_hora').value, observacoes: $('#d_obs').value,
      btn: $('#btnDesk'), msgEl: $('#d_msg')
    });
    if(ok) ev.target.reset();
  });

  // ======= MOBILE modal =======
  const modal = $('#modalMobile');
  $('#abrirMobile').addEventListener('click', ()=>{
    $('#m_msg').textContent='';
    modal.classList.add('show');
  });
  $('#fecharMobile').addEventListener('click', ()=> modal.classList.remove('show'));
  modal.addEventListener('click', (e)=>{ if(e.target===modal) modal.classList.remove('show'); });

  $('#m_telefone').addEventListener('input', e=> e.target.value = maskPhone(e.target.value));
  $('#formMobile').addEventListener('submit', async (ev)=>{
    ev.preventDefault();
    if($('#hp').value) return; // honeypot
    const ok = await enviarReserva({
      nome: $('#m_nome').value, email: $('#m_email').value, telefone: $('#m_telefone').value,
      pessoas: $('#m_pessoas').value, mesa: $('#m_mesa').value, data: $('#m_data').value,
      hora: $('#m_hora').value, observacoes: $('#m_obs').value,
      btn: $('#btnMobile'), msgEl: $('#m_msg')
    });
    if(ok){ ev.target.reset(); modal.classList.remove('show'); }
  });
</script>
</body>
</html>
