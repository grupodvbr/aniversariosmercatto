<!doctype html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel • Reservas de Aniversário — Mercatto Delícia</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --brand:#d4af37; --brand-2:#f5d26a; --text:#f8f7f4; --muted:#cfc8b0; --line:#292929;
    --bg:#000; --panel:#111214; --ok:#16a34a; --warn:#f59e0b; --danger:#ef4444;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif;color:var(--text);background:var(--bg)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:16px 18px;border-bottom:1px solid #1a1a1a;background:#0b0c0d}
  h1{margin:0;font-size:18px;color:var(--brand-2);letter-spacing:.3px}
  .toolbar{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;padding:12px 18px;background:#0c0d0f;border-bottom:1px solid #181818}
  .toolbar input,.toolbar select,.toolbar button{
    width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2a2a;background:#0e0f12;color:var(--text)
  }
  .toolbar button.brand{
    background:linear-gradient(180deg,var(--brand),#c79b1d);color:#1a1500;border:1px solid #d0a62d;font-weight:800;cursor:pointer
  }
  main{padding:16px 18px}
  .card{background:var(--panel);border:1px solid #1f1f1f;border-radius:14px;overflow:hidden}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:12px;border-bottom:1px solid #1f1f1f;font-size:14px;text-align:left}
  .table th{background:#0e0f12;color:var(--muted);position:sticky;top:0;z-index:1}
  .tag{padding:4px 8px;border-radius:999px;border:1px solid #2a2a2a;background:#0e0f12;color:#ddd;font-size:12px}
  .tag.ok{border-color:rgba(22,163,74,.5)}
  .tag.warn{border-color:rgba(245,158,11,.5)}
  .tag.danger{border-color:rgba(239,68,68,.5)}
  .row-actions{display:flex;gap:6px;flex-wrap:wrap}
  .ghost{background:#0000;border:1px solid #2a2a2a;color:var(--text);border-radius:8px;padding:6px 10px;cursor:pointer}
  .ghost:hover{border-color:#3a3a3a}
  .footer-bar{display:flex;gap:10px;justify-content:flex-end;padding:10px;background:#0c0d0f;border-top:1px solid #1a1a1a}
  .empty{padding:28px;color:#aaa;text-align:center}
  .grid-cols{display:grid;grid-template-columns:1fr;gap:14px}
  @media(min-width:1000px){ .grid-cols{grid-template-columns:1fr} }
  .badge{font-weight:700}
  .muted{color:var(--muted)}
</style>
</head>
<body>
<header>
  <h1>Mercatto Delícia — Painel de Reservas (Aniversários)</h1>
  <div class="muted" id="infoSpan">carregando…</div>
</header>

<section class="toolbar">
  <input type="date" id="fDe" />
  <input type="date" id="fAte" />
  <select id="fStatus">
    <option value="">Status (todos)</option>
    <option>Pendente</option>
    <option>Confirmado</option>
    <option>Compareceu</option>
    <option>Cancelado</option>
    <option>No-show</option>
  </select>
  <select id="fOrigem">
    <option value="">Origem (todas)</option>
    <option>site</option>
    <option>mobile</option>
    <option>desktop</option>
    <option>desktop-quick</option>
  </select>
  <input id="fBusca" placeholder="Buscar nome, telefone, e-mail, observação..." />
  <button class="brand" id="btnBuscar">Buscar</button>
</section>

<main>
  <div class="grid-cols">
    <div class="card">
      <table class="table" id="tbl">
        <thead>
          <tr>
            <th style="min-width:120px">Data • Hora</th>
            <th>Nome</th>
            <th>Telefone</th>
            <th>Pessoas</th>
            <th>Mesa</th>
            <th>Status</th>
            <th>Origem</th>
            <th style="min-width:280px">Ações</th>
          </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="8" class="empty">Carregando…</td></tr>
        </tbody>
      </table>
      <div class="footer-bar">
        <button class="ghost" id="btnCSV">Exportar CSV</button>
        <span class="muted" id="resumo"></span>
      </div>
    </div>
  </div>
</main>

<script>
const CONFIG = {
  SHEET_ENDPOINT: "COLE_AQUI_SUA_URL_DO_WEBAPP/exec" // <- troque
};

const $ = s=>document.querySelector(s);
const formatTel = t => String(t||'').replace(/\D/g,'').replace(/^(\d{2})(\d{4,5})(\d{4}).*/, '($1) $2-$3');

function qs(obj){ return Object.entries(obj).filter(([,v])=>v!==''&&v!=null).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&'); }

async function getInfo(){
  try{
    const r = await fetch(`${CONFIG.SHEET_ENDPOINT}?acao=info`);
    const j = await r.json();
    if(j.ok){ $('#infoSpan').textContent = 'conectado'; }
    else { $('#infoSpan').textContent = 'erro na API'; }
  }catch(_){ $('#infoSpan').textContent = 'offline'; }
}

async function listar(){
  const de   = $('#fDe').value;
  const ate  = $('#fAte').value;
  const status = $('#fStatus').value;
  const origem = $('#fOrigem').value;
  const q    = $('#fBusca').value.trim();
  const query = qs({acao:'listar', de, ate, status, origem, q, lim:1000});

  $('#tbody').innerHTML = `<tr><td colspan="8" class="empty">Carregando…</td></tr>`;

  try{
    const r = await fetch(`${CONFIG.SHEET_ENDPOINT}?${query}`);
    const j = await r.json();
    if(!j.ok){ throw new Error(j.error||'Falha'); }
    renderRows(j.rows||[]);
  }catch(e){
    console.error(e);
    $('#tbody').innerHTML = `<tr><td colspan="8" class="empty">Falha ao carregar</td></tr>`;
  }
}

function renderRows(rows){
  if(!rows.length){
    $('#tbody').innerHTML = `<tr><td colspan="8" class="empty">Sem registros para os filtros.</td></tr>`;
    $('#resumo').textContent = '';
    return;
  }
  const frag = document.createDocumentFragment();
  rows.forEach(r=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><div class="badge">${r.Data||''}</div><div class="muted">${r.Hora||''}</div></td>
      <td>${escapeHtml(r.Nome||'')}</td>
      <td>${formatTel(r.Telefone||'')}</td>
      <td>${r.Pessoas||''}</td>
      <td>${escapeHtml(r.Mesa||'')}</td>
      <td>${statusTag(r.Status)}</td>
      <td><span class="tag">${escapeHtml(r.Origem||'')}</span></td>
      <td>
        <div class="row-actions">
          ${btnStatus(r.ID,'Confirmado')}
          ${btnStatus(r.ID,'Cancelado')}
          ${btnStatus(r.ID,'Compareceu')}
          ${btnStatus(r.ID,'No-show')}
          <button class="ghost" onclick='imprimir(${JSON.stringify(r)})'>Imprimir</button>
          ${btnWhats(r)}
        </div>
      </td>
    `;
    frag.appendChild(tr);
  });
  $('#tbody').innerHTML = '';
  $('#tbody').appendChild(frag);
  $('#resumo').textContent = `${rows.length} reservas encontradas`;
}

function statusTag(s){
  const m = String(s||'').toLowerCase();
  let cls = '';
  if(m==='confirmado'||m==='compareceu') cls='ok';
  else if(m==='pendente') cls='warn';
  else cls='danger';
  return `<span class="tag ${cls}">${escapeHtml(s||'')}</span>`;
}

function btnStatus(id, novo){
  return `<button class="ghost" onclick="mudarStatus('${id}','${novo}')">${novo}</button>`;
}

function btnWhats(r){
  const d = String(r.Telefone||'').replace(/\D/g,'');
  if(d.length<10) return '';
  const msg = `Olá, ${r.Nome||''}! Aqui é do Mercatto Delícia confirmando sua reserva de aniversário para ${r.Data||''} às ${r.Hora||''}. Qualquer dúvida estamos à disposição.`;
  const href = `https://wa.me/55${d}?text=${encodeURIComponent(msg)}`;
  return `<a class="ghost" href="${href}" target="_blank" rel="noopener">WhatsApp</a>`;
}

async function mudarStatus(id, novo){
  try{
    const r = await fetch(`${CONFIG.SHEET_ENDPOINT}?acao=status&id=${encodeURIComponent(id)}&novo=${encodeURIComponent(novo)}&autor=Painel`, { method:'GET' });
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'Falha');
    await listar(); // reload
  }catch(e){
    alert('Erro ao alterar status: '+e.message);
  }
}

function imprimir(rec){
  const w = window.open('', '_blank');
  const html = `
    <html><head><meta charset="utf-8"><title>Reserva ${rec.ID}</title>
      <style>
        body{font-family:Arial, sans-serif;padding:20px}
        h1{font-size:18px;margin:0 0 10px}
        .b{font-weight:bold}
        .box{border:1px solid #ccc;border-radius:8px;padding:12px}
        .row{margin:6px 0}
      </style>
    </head>
    <body onload="window.print();">
      <h1>Mercatto Delícia — Reserva</h1>
      <div class="box">
        <div class="row"><span class="b">ID:</span> ${rec.ID||''}</div>
        <div class="row"><span class="b">Nome:</span> ${escapeHtml(rec.Nome||'')}</div>
        <div class="row"><span class="b">Telefone:</span> ${escapeHtml(rec.Telefone||'')}</div>
        <div class="row"><span class="b">Pessoas:</span> ${rec.Pessoas||''}</div>
        <div class="row"><span class="b">Data/Hora:</span> ${rec.Data||''} ${rec.Hora||''}</div>
        <div class="row"><span class="b">Mesa:</span> ${escapeHtml(rec.Mesa||'')}</div>
        <div class="row"><span class="b">Status:</span> ${escapeHtml(rec.Status||'')}</div>
        <div class="row"><span class="b">Obs.:</span> ${escapeHtml(rec.Observacoes||'')}</div>
      </div>
    </body></html>
  `;
  w.document.write(html); w.document.close();
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
}

$('#btnBuscar').addEventListener('click', listar);

// Export CSV
$('#btnCSV').addEventListener('click', async ()=>{
  const de=$('#fDe').value, ate=$('#fAte').value, status=$('#fStatus').value, origem=$('#fOrigem').value, q=$('#fBusca').value.trim();
  const query = qs({acao:'listar', de, ate, status, origem, q, lim:2000});
  try{
    const r = await fetch(`${CONFIG.SHEET_ENDPOINT}?${query}`);
    const j = await r.json();
    if(!j.ok) throw new Error(j.error||'Falha');
    const rows = j.rows||[];
    const headers = ['ID','Status','Origem','Nome','Email','Telefone','Pessoas','Mesa','Data','Hora','DataHora','Observacoes','Timestamp'];
    const csv = [headers.join(';')].concat(rows.map(r=>[
      r.ID,r.Status,r.Origem,r.Nome,r.Email,r.Telefone,r.Pessoas,r.Mesa,r.Data,r.Hora,r.DataHora,(r.Observacoes||'').replace(/\r?\n/g,' '),r.Timestamp
    ].map(v=>`"${String(v??'').replace(/"/g,'""')}"`).join(';'))).join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=`reservas_${new Date().toISOString().slice(0,10)}.csv`; a.click();
    URL.revokeObjectURL(url);
  }catch(e){ alert('Falha ao exportar: '+e.message); }
});

// inicialização
getInfo().then(listar);
</script>
</body>
</html>
